<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Etiqueta 40×40mm — EAN-13 (centralizado)</title>

  <!-- Fonte e JsBarcode -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <style>
    :root{
      --label-w:40mm; --label-h:40mm;
      --quiet:2mm;                 /* quiet zone lateral */
      --name-h:10mm;
      --price-h:5mm;
      --bars-h:16.8mm;             /* altura do bloco do código na etiqueta */
      --digits-h:3mm;
      --font-name:3.1mm;
      --font-price:3.6mm;
      --font-digits:3.2mm;
    }

    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:#0b132b;color:#e5e7eb
    }

    .wrap{max-width:980px;margin:24px auto;padding:16px}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    h1{margin:0 0 8px;font-size:22px;font-weight:800}
    .lead{color:#9ca3af;margin:0 0 12px}

    /* layout principal: formulário + prévia + painel de cópia */
    .grid{
      display:grid; gap:14px;
      grid-template-columns: 1.2fr .9fr; /* prévia | painel */
    }
    form{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .full{grid-column:1/-1}
    label{display:block;font-size:12px;color:#9ca3af;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px}
    input,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #3b4252;background:#0b1220;color:#eef2f7}
    textarea{resize:vertical; min-height:90px}
    button{cursor:pointer;font-weight:600}
    .primary{background:#22c55e;border:none}
    .ghost{background:transparent;border:1px solid #3b4252}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .preview{margin-top:14px}

    /* ===== Etiqueta 40×40 ===== */
    .label{
      width:var(--label-w); height:var(--label-h);
      background:#fff; color:#111; border-radius:6px;
      display:grid; grid-template-rows:var(--name-h) var(--price-h) var(--bars-h) var(--digits-h);
      overflow:hidden; break-inside:avoid; page-break-inside:avoid;
      box-shadow:0 0 0 1px rgba(0,0,0,.06) inset;
    }
    .slot{display:flex; align-items:center; width:100%; padding:0 2mm;}
    .name{
      font-weight:800; font-size:var(--font-name); line-height:1.2;
      text-align:left;
      white-space:normal; word-break:break-word;
      display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical;
      overflow:hidden;
      padding-top:1mm;
    }
    .price{
      font-weight:800; font-size:var(--font-price); line-height:1;
      text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .bars{
      padding:0 var(--quiet);
      height:var(--bars-h);
      overflow:hidden;
      justify-content:center;       /* centraliza o código de barras */
      align-items:center;
    }

    /* IMPORTANTE: não esticar o SVG */
    #barcode{
      display:block;
      /* sem width/height forçados; deixamos o JS definir */
    }

    /* Renderização nítida das barras nos rasterizadores */
    .bars svg{
      shape-rendering:crispEdges;
      image-rendering:pixelated;
    }

    .digits{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:800;
      font-size:var(--font-digits);
      letter-spacing:.12em;
      white-space:nowrap;
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      text-align:center;
    }

    /* ===== Painel de cópia ===== */
    .copy-panel{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; height:fit-content }
    .copy-row{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-bottom:10px }
    .copy-row:last-child{ margin-bottom:0 }
    .copy-label{ font-size:12px; color:#9ca3af; text-transform:uppercase; letter-spacing:.06em; margin-bottom:6px }
    .copy-value{ background:#0b1220; border:1px solid #3b4252; border-radius:10px; padding:10px 12px; min-height:40px; display:flex; align-items:center }
    .copy-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px }
    .toast{ position:fixed; right:14px; bottom:14px; background:#22c55e; color:#052e16; padding:10px 12px; border-radius:10px; font-weight:700; box-shadow:0 10px 30px rgba(0,0,0,.25); opacity:0; transform:translateY(8px); transition:.25s }
    .toast.show{ opacity:1; transform:translateY(0) }

    /* ===== PRINT ===== */
    @media print{
      @page{ size:40mm 40mm; margin:0 }
      html, body { width:40mm; height:40mm; margin:0; padding:0; background:#fff; overflow:hidden !important; }
      h1, .lead, form, .log, .validation, footer, .grid > .copy-panel { display:none !important; visibility:hidden !important; }
      .wrap{ margin:0 !important; padding:0 !important }
      .preview{ margin:0 !important; display:block !important }
      .label{
        position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
        width:40.8mm; height:39.8mm; border-radius:0; box-shadow:none;
        --name-h:10mm; --price-h:5mm; --bars-h:16.8mm; --digits-h:3mm;
        --font-name:3.0mm; --font-price:3.4mm; --font-digits:4.0mm;
      }
    }

    .validation{ color:#fca5a5; font-size:12px; margin-top:6px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Gerador de Código de Barras EAN-13</h1>
      <p class="lead">Nome e preço opcionais. Sem base de 12 dígitos, geramos <b>AAAAMMDD + 4 aleatórios</b>.</p>

      <form id="form">
        <div class="full">
          <label for="name">Nome (opcional)</label>
          <input id="name" placeholder="Ex.: Café Torrado Moído Extra Forte 500g">
        </div>
        <div>
          <label for="price">Preço (R$) (opcional)</label>
          <input id="price" inputmode="decimal" placeholder="Ex.: 23,00">
        </div>
        <div>
          <label for="eanBase">Base EAN (12 dígitos, opcional)</label>
          <input id="eanBase" inputmode="numeric" pattern="\d{12}" placeholder="Ex.: 789123456789">
        </div>
        <div class="actions full">
          <!-- <button type="submit" class="primary">Gerar</button> -->
          <!-- <button type="button" class="ghost" id="btnDownload" title="Baixar apenas o código de barras como PNG">Baixar PNG</button> -->
          <button type="button" class="ghost" id="btnPrint">Imprimir</button>
        </div>
        <div class="validation" id="validation" role="status" aria-live="polite"></div>
      </form>

      <div class="grid">
        <div>
          <div class="preview">
            <div class="label" id="label">
              <div class="slot name"  id="labelName"></div>
              <div class="slot price" id="labelPrice"></div>
              <div class="slot bars" id="barsSlot">
                <svg id="barcode"></svg>
              </div>
              <div class="slot digits" id="codeText">0000000000000</div>
            </div>
          </div>
        </div>

        <!-- Painel de cópia -->
        <aside class="copy-panel" aria-label="Conteúdo para copiar">
          <div class="copy-row">
            <div style="grid-column:1/-1" class="copy-label">Nome</div>
            <div class="copy-value" id="copyName" title="Nome"></div>
            <button class="ghost" id="btnCopyName" aria-label="Copiar nome">Copiar</button>
          </div>

          <div class="copy-row">
            <div style="grid-column:1/-1" class="copy-label">Preço</div>
            <div class="copy-value" id="copyPrice" title="Preço"></div>
            <button class="ghost" id="btnCopyPrice" aria-label="Copiar preço">Copiar</button>
          </div>

          <div class="copy-row">
            <div style="grid-column:1/-1" class="copy-label">EAN-13</div>
            <div class="copy-value" id="copyEan" title="Código EAN-13"></div>
            <button class="ghost" id="btnCopyEan" aria-label="Copiar EAN-13">Copiar</button>
          </div>

          <div class="copy-actions">
            <button class="primary" id="btnCopyAll">Copiar tudo</button>
            <button class="ghost" id="btnCopyCSV" title="Copia como CSV: nome;preço;ean">Copiar em CSV</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Parâmetros fáceis =====
    const BAR_WIDTH_MM = 0.468;  // espessura da barra (X-dimension)
    const BAR_HEIGHT_MM = 18.8;  // altura desejada das barras (em mm)
    const LINE_COLOR    = '#000';

    const $ = id => document.getElementById(id);

    // Conversões simples
    const MM_PER_IN = 22.4;
    function mmToPx(mm){
      // aproximação usando CSS 96dpi (1in = 96px). Na impressão, use "tamanho real" (100%).
      return (mm / MM_PER_IN) * 96;
    }

    function ean13CheckDigit(d12){
      let sum=0;
      for(let i=0;i<12;i++){
        sum += (i%2 ? 3 : 1) * (d12.charCodeAt(i)-48);
      }
      return (10 - (sum % 10)) % 10;
    }
    function generateBase(){
      const d=new Date();
      return d.getFullYear()
        + String(d.getMonth()+1).padStart(2,'0')
        + String(d.getDate()).padStart(2,'0')
        + String(Math.floor(Math.random()*10000)).padStart(4,'0');
    }
    function makeEan13(base12){ return base12 + ean13CheckDigit(base12); }

    function formatPriceBRL(raw){
      const s = (raw||'').toString().trim();
      if(!s) return '';
      // normaliza vírgula/ponto
      const normalized = s.replace(/\./g,'').replace(',', '.');
      const n = Number(normalized);
      if(!isFinite(n)) return `R$ ${s}`;
      return new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'}).format(n);
    }

    function validateBase12(base){
      if(!/^\d{12}$/.test(base)) return 'A base EAN deve ter exatamente 12 dígitos numéricos.';
      return '';
    }

    function renderBarcode(code){
      const barsSlot = $('barsSlot');

      // Altura desejada (em px) a partir do parâmetro
      const desiredHeightPx = Math.max(10, Math.round(mmToPx(BAR_HEIGHT_MM)));
      // Altura máxima possível pelo slot (sem vazar)
      const slotMaxPx = Math.max(10, Math.floor(barsSlot.clientHeight || desiredHeightPx));
      // Usa o menor para não estourar o layout
      const heightPx = Math.min(desiredHeightPx, slotMaxPx);

      // Largura mínima da barra em px a partir dos mm definidos
      const widthPx = Math.max(1, Math.round(mmToPx(BAR_WIDTH_MM)));

      // Renderização do SVG pelo JsBarcode (sem margem interna; quiet zone vem do padding do slot)
      JsBarcode('#barcode', code, {
        format:'ean13',
        displayValue:false,
        margin:12,
        width: widthPx,
        height: heightPx,
        lineColor: LINE_COLOR
      });

      // NÃO force width/height via CSS; não altere preserveAspectRatio.
      $('codeText').textContent = code;
    }

    // === utilitarios de cópia ===
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        showToast('Copiado!');
      }catch(err){
        // fallback: usa um textarea temporário
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); showToast('Copiado!'); }
        catch(e){ showToast('Não foi possível copiar'); }
        finally{ ta.remove(); }
      }
    }
    let toastTimer;
    function showToast(msg){
      const t=$('toast');
      t.textContent=msg; t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>t.classList.remove('show'),1600);
    }

    // Atualiza painel de cópia
    function updateCopyPanel({name, priceFmt, ean}){
      $('copyName').textContent = name || '';
      $('copyPrice').textContent = priceFmt || '';
      $('copyEan').textContent = ean || '';

      // Botões individuais
      $('btnCopyName').onclick = ()=> copyToClipboard(name || '');
      $('btnCopyPrice').onclick = ()=> copyToClipboard(priceFmt || '');
      $('btnCopyEan').onclick = ()=> copyToClipboard(ean || '');

      // Tudo junto (linhas)
      $('btnCopyAll').onclick = ()=> {
        const lines = [
          name || '',
          priceFmt || '',
          ean || ''
        ].join('\n');
        copyToClipboard(lines);
      };

      // CSV: nome;preco;ean (ponto e vírgula)
      $('btnCopyCSV').onclick = ()=>{
        // remove R$ e espaços do preço para CSV numérico simples, mas mantém vírgula decimal
        const precoCSV = (priceFmt||'').replace(/\s|R\$\s?/g,'');
        const csv = `${(name||'').replaceAll(';',',')};${precoCSV};${ean||''}`;
        copyToClipboard(csv);
      };
    }

    function generateAndRender(){
      const name = $('name').value.trim();
      const priceStr = $('price').value;
      let base = ($('eanBase').value||'').replace(/\D/g,'');

      if(!base) base = generateBase();

      const err = validateBase12(base);
      $('validation').textContent = err;
      if(err) return;

      const ean = makeEan13(base);

      const priceFmt = priceStr ? formatPriceBRL(priceStr) : '';
      $('labelName').textContent = name;
      $('labelPrice').textContent = priceFmt;

      renderBarcode(ean);
      updateCopyPanel({name, priceFmt, ean});
    }

    // Baixar apenas o código de barras como PNG (o label completo é para impressão)
    async function downloadBarcodePNG(){
      // Serializa o SVG do código
      const svg = $('barcode');
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);

      // Cria imagem a partir do SVG
      const svgBlob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      const load = new Promise(res=> img.onload = res);
      img.src = url;
      await load;

      // Desenha em canvas em resolução 2x para nitidez
      const scale = 2;
      const canvas = document.createElement('canvas');
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(url);

      // Baixa
      const a = document.createElement('a');
      a.download = 'barcode-ean13.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    }

    // Eventos
    document.addEventListener('DOMContentLoaded', ()=>{
      generateAndRender();
      // re-render ao redimensionar (altura do slot muda em alguns navegadores)
      window.addEventListener('resize', ()=>{
        const codeNow = $('codeText').textContent.replace(/\D/g,'');
        if(codeNow.length === 13) renderBarcode(codeNow);
      });
    });

    $('form').addEventListener('submit', ev=>{
      ev.preventDefault();
      generateAndRender();
    });

    $('btnPrint').addEventListener('click', ()=>{
      generateAndRender();
      setTimeout(()=>window.print(), 50);
    });

    $('btnDownload').addEventListener('click', async ()=>{
      // garante que o código atual foi renderizado
      generateAndRender();
      await downloadBarcodePNG();
    });
  </script>
</body>
</html>
